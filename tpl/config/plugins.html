<?php if(!defined('ELBP')) exit; ?>

<?= (!empty($MSGS['errors'])) ? elbp_error_alert_box($MSGS['errors']) : '' ?>
<?= (!empty($MSGS['success'])) ? elbp_success_alert_box($MSGS['success']) : '' ?>

<h2><?= $string['installnewplugin'] ?></h2>
<p><?= $string['installnewplugin:desc'] ?></p>

<script>
    
    var dir = '/';
    var plugin_type = '';
    var mod_or_block = '';
    var plugin_name = '';
    
    function rebuild_dir()
    {
        
        dir = '/';
        
        if (plugin_type == 'core'){
            dir = dir + 'blocks/elbp/plugins/';
        }
        
        if (plugin_type == 'external' && mod_or_block != 'other'){
            dir = dir + mod_or_block + '/';
        }
                
        dir = dir + plugin_name + '/' + plugin_name + '.class.php';
        
        if (plugin_type == 'external' && mod_or_block == 'other'){
            dir = '/' + plugin_name  + '.class.php';
        }
        
        $('#plugin_path').val(dir);
        
        return dir;
        
    }
    
    function load_plugin_type(type)
    {
        
        $('#mod_or_block').css('display', 'none');
        $('#plugin_name').css('display', 'none');
        $('#install_file_msg').css('display', 'none');
        $('#submit_td').css('display', 'none');
        
        plugin_type = type;
        
        if (type == 'core'){
            $('#mod_or_block').css('display', 'none');
            $('#plugin_name').html('<option value=""></option>');
            <?php foreach ($dir_plugins as $plugin): ?>
                $('#plugin_name').append('<option value="<?= $plugin ?>"><?= $plugin ?></option>');
            <?php endforeach; ?>
            $('#plugin_name').css('display', 'block');
            $('#other_plugin_name').css('display', 'none');
        }
        else if(type == 'external'){
            $('#plugin_name').css('display', 'none');
            $('#plugin_name').html('');
            $('#mod_or_block').css('display', 'block');
            $('#other_plugin_name').css('display', 'none');
        }
    }
    
    function load_external_plugins(type)
    {
        
        $('#plugin_name').css('display', 'none');
        $('#install_file_msg').css('display', 'none');
        $('#submit_td').css('display', 'none');
        mod_or_block = type;
        
        if (type == 'blocks'){
            $('#plugin_name').html('<option value=""></option>');
            <?php foreach ($dir_blocks as $plugin): ?>
                $('#plugin_name').append('<option value="<?= $plugin ?>"><?= $plugin ?></option>');
            <?php endforeach; ?>
            $('#plugin_name').css('display', 'block');
            $('#other_plugin_name').css('display', 'none');
        }
        else if(type == 'mod'){
            $('#plugin_name').html('<option value=""></option>');
            <?php foreach ($dir_mods as $plugin): ?>
                $('#plugin_name').append('<option value="<?= $plugin ?>"><?= $plugin ?></option>');
            <?php endforeach; ?>
            $('#plugin_name').css('display', 'block');
            $('#other_plugin_name').css('display', 'none');
        }
        else if(type == 'other'){
            $('#plugin_name').html('');
            $('#plugin_name').css('display', 'none');
            $('select#plugin_name').css('display', 'none');
            $('#other_plugin_name').css('display', 'block');
            load_submit_button('');
        }
    }
    
    function load_submit_button(name){
        $('#install_file_msg').css('display', 'block');
        plugin_name = name;
        $('#file_name').text( rebuild_dir() );
        $('#submit_td').css('display', 'block');
    }
    
    function retype_file_name(name){
        plugin_file = name;
        $('#file_name').text( rebuild_dir() );
    }
    
    function change_plugin_file(){
        
        if ( $('#file_name').css('display') != 'none')
        {
            $('#file_name').hide();
            $('#file_name_input').val( $('#file_name').text() );
            $('#file_name_input').show();
        }
        else
        {
            $('#file_name_input').hide();
            $('#file_name').text( $('#file_name_input').val() );
            $('#plugin_path').val( $('#file_name_input').val() );
            $('#file_name').show();
        }
        
    }
    
    var numGroups = <?= count($groups); ?>;
    
    function addNewPluginGroup(){
        
        numGroups++;
        
        $('#plugin_groups_body').append('<tr><td><input type="hidden" class="normal" name="group_id['+numGroups+']" value="-1" /><input type="text" class="normal" name="group_name['+numGroups+']" value="" /></td><td><input type="checkbox" name="enable_disable_group['+numGroups+']" /></td><td><ul id="" class=""></ul></td><td><input type="text" class="elbp_small" name="group_order['+numGroups+']" value="" /></td>|</tr>');
        
    }
    
       
</script>

<form action="" method="post">
<table>    
    
    <tr>
        <td>
            <select onchange="load_plugin_type(this.value);return false;">
                <option value=""></option>
                <option value="core"><?= $string['coreplugin'] ?></option>
                <option value="external"><?= $string['externalplugin'] ?></option>
            </select>
        </td>
        <td>
            <select id="mod_or_block" style="display:none" onchange="load_external_plugins(this.value);return false;">
                <option value=""></option>
                <option value="blocks"><?= get_string('block') ?></option>
                <option value="mod"><?= $string['mod'] ?></option>
                <option value="other"><?= $string['other'] ?></option>
            </select>
        </td>
        <td>
            <select id="plugin_name" name="plugin_name" style="display:none" onchange="load_submit_button(this.value);return false;">
                
            </select>
            <input type="text" name="plugin_name_2" style="display:none;" id="other_plugin_name" placeholder="Plugin Name" />
        </td>
        <td>
            <span id="install_file_msg" style="display:none;"><?= $string['willattemptinstallfile'] ?>:<br><small title="<?= $string['clickmeedit'] ?>" id="file_name" onclick="change_plugin_file();"></small><input type="text" id="file_name_input" style="display:none;" onblur="change_plugin_file();" /></span>
        </td>
        <td id="submit_td" style="display:none;">
            <input type="hidden" id="plugin_path" name="plugin_path" value="" />
            <input type="submit" name="install_new_plugin" value="<?= $string['install'] ?>" />
        </td>
    </tr>
    
</table>
</form>

<br>

<h2><?= $string['addnewcustomplugin'] ?></h2>
<p><?= $string['addnewcustomplugin:desc'] ?></p>

<form action="" method="post" enctype="multipart/form-data">
    
    <div>
        <small><?= $string['title'] ?></small> <input type="text" name="title" value="" /> <input type="submit" name="add_new_custom_plugin" value="<?= $string['create'] ?>" />
    </div>
    
    <br>
    <p><?= $string['importcustomplugin:desc'] ?></p>
    
    <div>
        <small><?= $string['import'] ?></small> <input type="file" name="plugin_xml" value="" />  <input type="submit" name="import_custom_plugin" value="<?= $string['import'] ?>" />
    </div>
    
</form>

<br>

<h2><?= $string['manageplugins'] ?></h2>
<div style="overflow-x:scroll;">
    <table class="elbp_config">
        <tr>
            <th><?= get_string('name') ?></th>
            <th><?= $string['path'] ?></th>
            <th><?= $string['version'] ?></th>
            <th><?= $string['update'] ?></th>
            <th><?= $string['enabledisable'] ?></th>
            <th><?= $string['settings'] ?></th>
            <th><?= $string['uninstall'] ?></th>
        </tr>

        <?php foreach($nameOrderedPlugins as $plugin): ?>
        <tr class="<?= (isset($plugin->custom)) ? 'custom' : ''; ?>" >
            <td><?= $plugin->getTitle() ?></td>
            <td><?= $plugin->getPath() ?></td>
            <td title="<?= $plugin->getVersionDateString() ?>">
                <?php if (isset($plugin->custom)): ?>
                    <?= $string['na'] ?>
                <?php else: ?>
                    <?= $plugin->getVersion() ?>
                <?php endif; ?>
            </td>
            <td>
                <?php if (isset($plugin->custom)): ?>
                    <?= $string['na'] ?>
                <?php else: ?>
                    <?php if($plugin->getVersion() < $block_version): ?>
                        <form action="" method="post"><input type="hidden" name="plugin_id" value="<?= $plugin->getID() ?>" /> <input style="width:16px;height:16px;" type="image" src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/update.png" name="upgrade_plugin" /></form>
                    <?php else: ?>
                        <img title="<?= $string['pluginuptodate'] ?>" src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/tick.png" style="width:16px;height:16px;" />
                    <?php endif; ?>       
                <?php endif; ?>  
            </td>
            <td><form action="" method="post"><input type="hidden" name="plugin_id" value="<?= $plugin->getID() ?>" /> <input type="image" src="<?= ($plugin->isEnabled()) ? elbp_image_url('i/hide') : elbp_image_url('i/show') ?>" name="<?= (isset($plugin->custom)) ? 'enable_disable_custom_plugin' : 'enable_disable_plugin'; ?>" title="<?= ($plugin->isEnabled()) ? $string['enabled'] : $string['disabled']; ?>" /></form></td>
            <td><a href="<?= $CFG->wwwroot ?>/<?= $plugin->getConfigPath() ?>" target="_blank"><?= $string['settings'] ?></a></td>
            <td><a href="<?= $CFG->wwwroot ?>/blocks/elbp/config.php?view=uninstall&<?= (isset($plugin->custom)) ? 'customplugin' : 'plugin'; ?>=<?= $plugin->getID() ?>"><img src="<?= elbp_image_url('t/delete') ?>" alt="<?= $string['uninstall'] ?>" title="<?= $string['uninstallplugin'] ?>: <?= elbp_html($plugin->getTitle()) ?>" /></a></td>
            <?php if(isset($plugin->custom)): ?>
                <td><form action="" method="post"><input type="hidden" name="custom_plugin_id" value="<?= $plugin->getID() ?>" /> <input type="image" src="<?= elbp_image_url('i/export') ?>" name="export_custom_plugin" alt="<?= $string['export'] ?>" title="<?= $string['exportcustomplugin'] ?>" /></form></td>
            <?php endif; ?>
        </tr>

        <?php endforeach; ?>

    </table>
</div>

<br><br>

<h2><?= $string['managepluginlayouts'] ?></h2>

<div id="plugin_groups_output" class="elbp_success_box" style="display:none;"></div>

<form action="" method="post">
    
    <div id="elbp_plugin_layouts_form">
    
    <input type="button" onclick="elbp_add_new_plugin_layout();return false;" value="<?= $string['addnewlayout'] ?>" /><br><br>
            
        <?php $layoutNum = 1; ?>
        
        <?php if ($layouts): ?>
        
            <?php foreach($layouts as $layout): ?>
            
                <table id='elbp_plugin_layout_<?= $layoutNum ?>' class='elbp_plugin_layouts'>
            
                    <tr>
                        <td>
                            <a href="#" onclick="elbp_delete_layout(<?= $layoutNum ?>);return false;"><img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/remove.png" alt="<?= $string['delete'] ?>" /></a>
                        </td>
                    </tr>
                    
                    <tr>
                        <td><?= $string['layoutname'] ?></td>
                        <td>
                            <input type="hidden" name="plugin_layouts_id[<?= $layoutNum ?>]" value="<?= $layout->getID() ?>" />
                            <input type="text" name="plugin_layouts_name[<?= $layoutNum ?>]" value="<?= \elbp_html($layout->getName()) ?>" />
                        </td>
                    </tr>

                    <tr>
                        <td><?= $string['default'] ?></td>
                        <td>
                            <input type="checkbox" name="plugin_layouts_default[<?= $layoutNum ?>]" value="1" <?= ($layout->isDefault()) ? 'checked' : '' ?> />
                        </td>
                    </tr>

                    <tr>
                        <td><?= $string['enabled'] ?></td>
                        <td>
                            <input type="checkbox" name="plugin_layouts_enabled[<?= $layoutNum ?>]" value="1" <?= ($layout->isEnabled()) ? 'checked' : '' ?> />
                        </td>
                    </tr>
                    <tr>
                        <td colspan='2' id="">
                            <?php foreach($plugins as $plugin): ?>
                                <?php if ($plugin->hasPluginBox()): ?>
                                    <div class='elbp_layout_plugin_name' id="plugin_<?= $plugin->quickID ?>_<?= $layoutNum ?>" layoutID="<?= $layout->getID() ?>" layoutNum="<?= $layoutNum ?>" onclick="elbp_add_plugin_to_group(<?= $layoutNum ?>, '<?= $plugin->quickID ?>');return false;" style="display:<?= ($layout->isPluginInLayoutGroups($plugin->quickID)) ? 'none' : 'inline-block'; ?>;background-color:<?= $plugin->getHeaderBackgroundColour() ?>;color:<?= $plugin->getHeaderFontColour() ?>;"><?= $plugin->getTitle() ?></div>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="2"><?= $string['groups'] ?> <a href="#" onclick="elbp_add_new_plugin_group(<?= $layoutNum ?>);return false;"><img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/add_small.png" alt="<?= $string['addnewgroup'] ?>" /></a></th>
                    </tr>

                    <?php if ($layout->getGroups()): ?>

                        <?php $groupNum = 1; ?>

                        <?php foreach($layout->getGroups() as $group): ?>
                        
                            <tr class="layout_group_<?= $layoutNum ?>_<?= $groupNum ?>_row">
                                <td>
                                    <a href="#" onclick="elbp_delete_layout_group(<?= $layoutNum ?>, <?= $groupNum ?>);return false;"><img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/remove.png" alt="<?= $string['delete'] ?>" /></a>
                                </td>
                            </tr>
                        
                            <tr class="layout_group_<?= $layoutNum ?> layout_group_<?= $layoutNum ?>_<?= $groupNum ?>_row">
                                <td><?= $string['name'] ?></td>
                                <td>
                                    <input type="hidden" name="plugin_layouts_groups_id[<?= $layoutNum ?>][<?= $groupNum ?>]" value="<?= $group->id ?>" />
                                    <input type="text" name="plugin_layouts_groups_name[<?= $layoutNum ?>][<?= $groupNum ?>]" value="<?= \elbp_html($group->name) ?>" />
                                </td>
                            </tr>
                            
                            <tr class="layout_group_<?= $layoutNum ?>_<?= $groupNum ?>_row">
                                <td><?= $string['enabled'] ?></td>
                                <td><input type="checkbox" name="plugin_layouts_groups_enabled[<?= $layoutNum ?>][<?= $groupNum ?>]" value="1" <?= ($group->enabled == 1) ? 'checked' : ''; ?> /></td>
                            </tr>
                            
                            <tr class="layout_group_<?= $layoutNum ?>_<?= $groupNum ?>_row">
                                <td><?= $string['plugins'] ?></td>
                                <td>
                                    <small><a href="#" onclick="elbp_toggle_add_layout_plugins(<?= $layoutNum ?>, <?= $groupNum ?>);return false;" groupID="<?= $group->id ?>" groupNum="<?= $groupNum ?>" isAdding="0" class="elbp_add_layout_plugins_link_layout_<?= $layoutNum ?>" id="elbp_add_layout_plugins_link_<?= $layoutNum ?>_<?= $groupNum ?>"><?= $string['startaddingplugins'] ?></a></small>
                                    <div class="elbp_layout_plugins_dump elbp_layout_plugins_dump_<?= $layoutNum ?>" id="elbp_layout_plugins_dump_<?= $layoutNum ?>_<?= $groupNum ?>" groupNum="<?= $groupNum ?>" layoutNum="<?= $layoutNum ?>">
                                        <ul>
                                            <?php if ($group->plugins): ?>
                                                <?php foreach($group->plugins as $plugin): ?>
                                                    <li pluginID='<?= $plugin->quickID ?>'>
                                                        <?= $plugin->getTitle() ?> <a href="#" onclick="elbp_remove_plugin_from_group(<?= $layoutNum ?>, '<?= $plugin->quickID ?>', this);return false;"><img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/close_tiny.png" alt="<?= $string['remove'] ?>" /></a>
                                                        <input type="hidden" name="layout_group_plugins[<?= $layoutNum ?>][<?= $groupNum ?>][]" value="<?= $plugin->quickID ?>" /></li>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            
                            <tr class="layout_group_<?= $layoutNum ?>_<?= $groupNum ?>_row">
                                <td colspan="2">
                                    <br>
                                </td>
                            </tr>

                            <?php $groupNum++; ?>

                        <?php endforeach; ?>

                    <?php endif; ?>

                    <?php $layoutNum++; ?>
                
                </table>
                
            <?php endforeach; ?>
        
        <?php endif; ?>
        
    </div>
    
    <input type="submit" name="submit_plugin_layouts" value="<?= $string['save'] ?>" />
    
</form>



<script>
    
    function elbp_delete_layout(layoutNum){
        $('#elbp_plugin_layout_'+layoutNum).remove();
    }
    
    function elbp_delete_layout_group(layoutNum, groupNum){
        $('.layout_group_'+layoutNum+'_'+groupNum+'_row').remove();
    }
    
    // Add a new group to a layout
    function elbp_add_new_plugin_group(layoutNum){
        
        var numOfGroups = $('.layout_group_'+layoutNum).length;
        var groupNum = numOfGroups + 1;
        
        var output = "";
        
        output += "<tr class='layout_group_"+layoutNum+"_"+groupNum+"_row'>";
            output += "<td>";
                output += "<a href='#' onclick='elbp_delete_layout_group("+layoutNum+", "+groupNum+");return false;'><img src='<?= $CFG->wwwroot ?>/blocks/elbp/pix/remove.png' alt='<?= $string['delete'] ?>' /></a>";
            output += "</td>";
        output += "</tr>";
        
        output += "<tr class='layout_group_"+layoutNum+" layout_group_"+layoutNum+"_"+groupNum+"_row'>";
            output += "<td><?= $string['name'] ?></td>";
            output += "<td>";
                output += "<input type='hidden' name='plugin_layouts_groups_id["+layoutNum+"]["+groupNum+"]' value='' />";
                output += "<input type='text' name='plugin_layouts_groups_name["+layoutNum+"]["+groupNum+"]' value='' />";
            output += "</td>";
        output += "</tr>";
         
        output += "<tr class='layout_group_"+layoutNum+"_"+groupNum+"_row'>";
            output += "<td><?= $string['enabled'] ?></td>";
            output += "<td>";
                output += "<input type='checkbox' name='plugin_layouts_groups_enabled["+layoutNum+"]["+groupNum+"]' value='1' />";
            output += "</td>";
        output += "</tr>";
        
        output += "<tr class='layout_group_"+layoutNum+"_"+groupNum+"_row'>";
            output += "<td><?= $string['plugins'] ?></td>";
            output += "<td>";
                output += "<small><a href='#' onclick='elbp_toggle_add_layout_plugins("+layoutNum+", "+groupNum+");return false;' groupID='D"+groupNum+"' groupNum='"+groupNum+"' isAdding='0' class='elbp_add_layout_plugins_link_layout_"+layoutNum+"' id='elbp_add_layout_plugins_link_"+layoutNum+"_"+groupNum+"'><?= $string['startaddingplugins'] ?></a></small>";
                output += "<div class='elbp_layout_plugins_dump elbp_layout_plugins_dump_"+layoutNum+"' id='elbp_layout_plugins_dump_"+layoutNum+"_"+groupNum+"' groupNum='"+groupNum+"' layoutNum='"+layoutNum+"'><ul></ul></div>";
            output += "</td>";
        output += "</tr>";
        
         output += "<tr class='layout_group_"+layoutNum+"_"+groupNum+"_row'>";
            output += "<td colspan='2'><br></td>";
        output += "</tr>";
        
        $('#elbp_plugin_layout_'+layoutNum).append(output);     
        
        elbp_apply_plugin_layout_bindings();
        
    }
        
    // Add a new layout
    function elbp_add_new_plugin_layout(){
        
        var numOfLayouts = $('.elbp_plugin_layouts').length;
        var layoutNum = numOfLayouts + 1;
        
        var output = "";
        output += "<table id='elbp_plugin_layout_"+layoutNum+"' class='elbp_plugin_layouts'>";
            output += "<tr>";
                output += "<td>";
                    output += "<a href='#' onclick='elbp_delete_layout("+layoutNum+");return false;'><img src='<?= $CFG->wwwroot ?>/blocks/elbp/pix/remove.png' alt='<?= $string['delete'] ?>' /></a>";
                output += "</td>";
            output += "</tr>";
            output += "<tr>";
                output += "<td><?= $string['layoutname'] ?></td>";
                output += "<td><input type='hidden' name='plugin_layouts_id["+layoutNum+"]' value='' /><input type='text' name='plugin_layouts_name["+layoutNum+"]' value='' /></td>";
            output += "</tr>";
            output += "<tr>";
                output += "<td><?= $string['default'] ?></td>";
                output += "<td><input type='checkbox' name='plugin_layouts_default["+layoutNum+"]' value='1' /></td>";
            output += "</tr>";
            output += "<tr>";
                output += "<td><?= $string['enabled'] ?></td>";
                output += "<td><input type='checkbox' name='plugin_layouts_enabled["+layoutNum+"]' value='1' /></td>";
            output += "</tr>";
            output += "<tr>";
                output += "<td colspan='2'>";
                    <?php foreach($plugins as $plugin): ?>
                        <?php if ($plugin->hasPluginBox()): ?>
                            output += "<div class='elbp_layout_plugin_name' id='plugin_<?= (isset($plugin->custom) && $plugin->custom) ? 'c' : ''; ?><?= $plugin->getID() ?>_"+layoutNum+"' layoutNum='"+layoutNum+"' onclick='elbp_add_plugin_to_group(\""+layoutNum+"\", \"<?= (isset($plugin->custom) && $plugin->custom) ? 'c' : ''; ?><?= $plugin->getID() ?>\");return false;' style='background-color:<?= $plugin->getHeaderBackgroundColour() ?>;color:<?= $plugin->getHeaderFontColour() ?>;' ><?= $plugin->getTitle() ?></div>";
                        <?php endif; ?>
                    <?php endforeach; ?>
                output += "</td>";
            output += "</tr>";
            
            output += "<tr>";
                output += "<th colspan='2'><?= $string['groups'] ?> <a href='#' onclick='elbp_add_new_plugin_group("+layoutNum+");return false;'><img src='<?= $CFG->wwwroot ?>/blocks/elbp/pix/add_small.png' alt='<?= $string['addnewgroup'] ?>' /></a></th>";
            output += "</tr>";
            
        output += "</table>";
        
        $('#elbp_plugin_layouts_form').append(output);
        
    }
    
    
    // Toggle which layout group we are adding plugins to
    function elbp_toggle_add_layout_plugins(layoutNum, groupNum){
        
        // Get current value
        var isAdding = $('#elbp_add_layout_plugins_link_'+layoutNum+'_'+groupNum).attr('isAdding');
        
        // Reset all
        $('.elbp_add_layout_plugins_link_layout_'+layoutNum).attr('isAdding', 0);
        $('.elbp_add_layout_plugins_link_layout_'+layoutNum).text( "<?= $string['startaddingplugins'] ?>" );
        $('.elbp_layout_plugins_dump_'+layoutNum+' ul').removeClass('active');
        
        if (isAdding == 0){
            $('#elbp_add_layout_plugins_link_'+layoutNum+'_'+groupNum).attr('isAdding', 1);
            $('#elbp_add_layout_plugins_link_'+layoutNum+'_'+groupNum).text( "<?= $string['stopaddingplugins'] ?>" );
            $('#elbp_layout_plugins_dump_'+layoutNum+'_'+groupNum+' ul').addClass('active');
        }        
        
    }
    
    // Get the groupID we are adding plugins to, in a layout
    function elbp_get_layout_group_adding(layoutNum){
        
        var groupNum = false;
        var groups = $('.elbp_add_layout_plugins_link_layout_'+layoutNum);
        $.each(groups, function(){
            
            var isAdding = $(this).attr('isAdding');
            if (isAdding == 1){
                groupNum = $(this).attr('groupNum');
                return;
            }
            
        });
        
        return groupNum;
        
    }
    
    // Add a plugin to a layout group
    function elbp_add_plugin_to_group(layoutNum, pID){
        
        var groupNum = elbp_get_layout_group_adding(layoutNum);
        if (!groupNum){
            alert( '<?= $string['plschooseplugingroup'] ?>' );
            return false;
        }
        
        // Hide plugin name div
        var divElement = $('#plugin_'+pID+'_'+layoutNum);
        $('#plugin_'+pID+'_'+layoutNum).hide();
        
        // Add list item to group
        $('#elbp_layout_plugins_dump_'+layoutNum+'_'+groupNum+' ul').append('<li pluginID="'+pID+'">'+$(divElement).text()+' <a href="#" onclick="elbp_remove_plugin_from_group('+layoutNum+', \''+pID+'\', this);return false;"><img src="<?= $CFG->wwwroot ?>/blocks/elbp/pix/close_tiny.png" alt="<?= $string['remove'] ?>" /></a><input type="hidden" name="layout_group_plugins['+layoutNum+']['+groupNum+'][]" value="'+pID+'" /></li>');
                
    }
    
    // Remove a plugin from the layout group
    function elbp_remove_plugin_from_group(layoutNum, pID, el){
        
        // Remove list element
        $(el).parent().remove();
        
        // Show plugin in layout again so we can add it to a different group
        $('#plugin_'+pID+'_'+layoutNum).show();
        
    }
    
    
    function elbp_apply_plugin_layout_bindings(){
        
        
        $('.elbp_layout_plugins_dump ul').sortable( {
            placeholder: "elbp_layout_plugin_placeholder"
        } );
        $('.elbp_layout_plugins_dump ul').disableSelection();
        
    }
    
    
    $(document).ready( function(){
        
        elbp_apply_plugin_layout_bindings();
        
    } );
        
        
        
    
    
</script>